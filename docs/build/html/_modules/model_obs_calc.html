
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>model_obs_calc &#8212; Phitter 0.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<link rel="stylesheet" href="https://use.typekit.net/hxl8tqz.css">

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for model_obs_calc</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Light curve calculation functions,</span>
<span class="c1"># for fitting with PHOEBE</span>
<span class="c1"># ---</span>
<span class="c1"># Abhimat Gautam</span>

<span class="kn">import</span> <span class="nn">phoebe</span>
<span class="kn">from</span> <span class="nn">phoebe</span> <span class="kn">import</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">phoebe</span> <span class="kn">import</span> <span class="n">c</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">phoebe.parameters.dataset</span> <span class="kn">import</span> <span class="n">rv</span>
<span class="kn">from</span> <span class="nn">spisea</span> <span class="kn">import</span> <span class="n">synthetic</span>
<span class="kn">from</span> <span class="nn">phitter</span> <span class="kn">import</span> <span class="n">filters</span><span class="p">,</span> <span class="n">observables</span>
<span class="kn">from</span> <span class="nn">phitter.params</span> <span class="kn">import</span> <span class="n">star_params</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">modeling</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.font_manager</span> <span class="k">as</span> <span class="nn">font_manager</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span>
<span class="kn">import</span> <span class="nn">autofig</span>

<span class="c1"># Filters for default filter list</span>
<div class="viewcode-block" id="kp_filt"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.kp_filt">[docs]</a><span class="n">kp_filt</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">nirc2_kp_filt</span><span class="p">()</span></div>
<div class="viewcode-block" id="h_filt"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.h_filt">[docs]</a><span class="n">h_filt</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">nirc2_h_filt</span><span class="p">()</span></div>

<span class="c1"># Stellar Parameters</span>
<span class="c1"># stellar_params = (mass, rad, teff, mag_Kp, mag_H, pblum_Kp, pblum_H)</span>

<div class="viewcode-block" id="binary_star_model_obs"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.binary_star_model_obs">[docs]</a><span class="k">class</span> <span class="nc">binary_star_model_obs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute the observables for a modeled binary system,</span>
<span class="sd">    given stellar parameters and binary parameters.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bin_observables : observables</span>
<span class="sd">        observables object, with obs_times, obs_filts, and obs_types specified.</span>
<span class="sd">    use_blackbody_atm : bool, default=False</span>
<span class="sd">        Use blackbody atmosphere instead of default Castelli &amp; Kurucz</span>
<span class="sd">        atmosphere. Default: False (i.e.: using a C&amp;K atm by default)</span>
<span class="sd">    use_compact_object : bool, default=False</span>
<span class="sd">        If true, sets eclipse_method to &#39;only_horizon&#39; in PHOEBE, which is</span>
<span class="sd">        necessary for compact companions without eclipses. Default: False</span>
<span class="sd">    </span>
<span class="sd">    print_diagnostics : bool, default=False</span>
<span class="sd">        Print diagnostic messages, helpful for debugging.</span>
<span class="sd">    par_compute : bool, default=False</span>
<span class="sd">        Uses parallelization when computing with PHOEBE.</span>
<span class="sd">    num_par_processes : int, default=8</span>
<span class="sd">        Number of processes to use when parallel computing with PHOEBE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">bin_observables</span><span class="p">,</span>
            <span class="n">use_blackbody_atm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_compact_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">print_diagnostics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">par_compute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_par_processes</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span> <span class="o">=</span> <span class="n">bin_observables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span> <span class="o">=</span> <span class="n">use_blackbody_atm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span> <span class="o">=</span> <span class="n">use_compact_object</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span> <span class="o">=</span> <span class="n">print_diagnostics</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">par_compute</span> <span class="o">=</span> <span class="n">par_compute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_par_processes</span> <span class="o">=</span> <span class="n">num_par_processes</span>
        
        <span class="k">return</span>
    
<div class="viewcode-block" id="binary_star_model_obs.compute_obs"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.binary_star_model_obs.compute_obs">[docs]</a>    <span class="k">def</span> <span class="nf">compute_obs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">star1_params</span><span class="p">,</span> <span class="n">star2_params</span><span class="p">,</span>
            <span class="n">binary_params</span><span class="p">,</span>
            <span class="n">irrad_frac_refl</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">num_triangles</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
            <span class="n">make_mesh_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mesh_plot_phases</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">]),</span>
            <span class="n">animate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mesh_plot_fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_subplot_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_subplot_grid_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_temp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mesh_temp_cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_kwargs</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute observables with the specified star and binary</span>
<span class="sd">        system parameters.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        star1_params : star_params</span>
<span class="sd">            star_params object, with parameters for the primary star.</span>
<span class="sd">        star2_params : star_params</span>
<span class="sd">            star_params object, with parameters for the secondary star.</span>
<span class="sd">        binary_params : binary_params</span>
<span class="sd">            binary_params object, with parameters for the binary system</span>
<span class="sd">            configuration.</span>
<span class="sd">        irrad_frac_refl : float, default=1.0</span>
<span class="sd">            Fraction reflectivity for irradiation</span>
<span class="sd">        num_triangles : int, default=1500</span>
<span class="sd">            Number of triangles to use for PHOEBE&#39;s mesh model of each stellar</span>
<span class="sd">            atmosphere. For contact system, num_triangles*2 are used for contact</span>
<span class="sd">            envelope.</span>
<span class="sd">        make_mesh_plots : bool, default=False</span>
<span class="sd">            Make a mesh plot of the binary system. Default: False</span>
<span class="sd">        plot_name : str, default=None</span>
<span class="sd">            Name for the output plots, if making a mesh plot</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observables</span>
<span class="sd">            observables object returned. Deep copy of input observables object,</span>
<span class="sd">            with obs also defined, with modeled values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_compute</span><span class="p">:</span>
            <span class="n">phoebe</span><span class="o">.</span><span class="n">mpi_on</span><span class="p">(</span><span class="n">nprocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_par_processes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phoebe</span><span class="o">.</span><span class="n">mpi_off</span><span class="p">()</span>
        
        <span class="c1"># Read in the stellar parameters of the binary components</span>
        <span class="n">star1_mass</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">star1_rad</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">rad</span>
        <span class="n">star1_teff</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">teff</span>
        <span class="n">star1_logg</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">logg</span>
        <span class="n">star1_filt_pblums</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">pblums</span>
        
        <span class="n">star2_mass</span> <span class="o">=</span> <span class="n">star2_params</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">star2_rad</span> <span class="o">=</span> <span class="n">star2_params</span><span class="o">.</span><span class="n">rad</span>
        <span class="n">star2_teff</span> <span class="o">=</span> <span class="n">star2_params</span><span class="o">.</span><span class="n">teff</span>
        <span class="n">star2_logg</span> <span class="o">=</span> <span class="n">star2_params</span><span class="o">.</span><span class="n">logg</span>
        <span class="n">star2_filt_pblums</span> <span class="o">=</span> <span class="n">star2_params</span><span class="o">.</span><span class="n">pblums</span>
        
        <span class="c1"># Read in the parameters of the binary system</span>
        <span class="n">binary_period</span> <span class="o">=</span> <span class="n">binary_params</span><span class="o">.</span><span class="n">period</span>
        <span class="n">binary_ecc</span> <span class="o">=</span> <span class="n">binary_params</span><span class="o">.</span><span class="n">ecc</span>
        <span class="n">binary_inc</span> <span class="o">=</span> <span class="n">binary_params</span><span class="o">.</span><span class="n">inc</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">binary_params</span><span class="o">.</span><span class="n">t0</span>
        
        <span class="n">err_out</span> <span class="o">=</span> <span class="n">observables</span><span class="o">.</span><span class="n">observables</span><span class="p">(</span>
            <span class="n">obs_times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
            <span class="n">obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="n">err_out</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">])),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]))</span>
        
        <span class="c1"># Check for high temp ck2004 atmosphere limits</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
            <span class="c1"># log g = 3.5, high temp bounds (above 31e3 K)</span>
            <span class="k">if</span> <span class="n">star1_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">31_000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">&gt;</span> <span class="n">star1_logg</span> <span class="o">&gt;</span> <span class="mf">3.5</span><span class="p">):</span>
                <span class="n">star1_teff_round</span> <span class="o">=</span> <span class="mf">30995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star1_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_logg</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star1_teff&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_teff</span><span class="p">,</span> <span class="n">star1_teff_round</span><span class="p">))</span>
                
                <span class="n">star1_teff</span> <span class="o">=</span> <span class="n">star1_teff_round</span>
            <span class="k">if</span> <span class="n">star2_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">31_000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">&gt;</span> <span class="n">star2_logg</span> <span class="o">&gt;</span> <span class="mf">3.5</span><span class="p">):</span>
                <span class="n">star2_teff_round</span> <span class="o">=</span> <span class="mf">30995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star2_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_logg</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star2_teff&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_teff</span><span class="p">,</span> <span class="n">star2_teff_round</span><span class="p">))</span>
                
                <span class="n">star2_teff</span> <span class="o">=</span> <span class="n">star2_teff_round</span>
            
            <span class="c1"># log g = 4.0, high temp bounds (above 40e3 K)</span>
            <span class="k">if</span> <span class="n">star1_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">40000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.5</span> <span class="o">&gt;</span> <span class="n">star1_logg</span> <span class="o">&gt;</span> <span class="mf">4.0</span><span class="p">):</span>
                <span class="n">star1_teff_round</span> <span class="o">=</span> <span class="mf">39995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star1_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_logg</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star1_teff&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_teff</span><span class="p">,</span> <span class="n">star1_teff_round</span><span class="p">))</span>
                
                <span class="n">star1_teff</span> <span class="o">=</span> <span class="n">star1_teff_round</span>
            <span class="k">if</span> <span class="n">star2_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">40000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">&gt;</span> <span class="n">star2_logg</span> <span class="o">&gt;</span> <span class="mf">3.50</span><span class="p">):</span>
                <span class="n">star2_teff_round</span> <span class="o">=</span> <span class="mf">39995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star2_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_logg</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star2_teff&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_teff</span><span class="p">,</span> <span class="n">star2_teff_round</span><span class="p">))</span>
                
                <span class="n">star2_teff</span> <span class="o">=</span> <span class="n">star2_teff_round</span>
        
        <span class="c1"># Set up binary model</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">phoebe</span><span class="o">.</span><span class="n">default_binary</span><span class="p">()</span>
        
        <span class="c1">## Set a default distance</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
        
        <span class="c1">## Set period, semimajor axis, and mass ratio (q)</span>
        <span class="n">binary_sma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">binary_period</span><span class="o">**</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">const</span><span class="o">.</span><span class="n">G</span> <span class="o">*</span> <span class="p">(</span><span class="n">star1_mass</span> <span class="o">+</span> <span class="n">star2_mass</span><span class="p">))</span> <span class="o">/</span>\
            <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
        <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        
        <span class="n">binary_q</span> <span class="o">=</span> <span class="n">star2_mass</span> <span class="o">/</span> <span class="n">star1_mass</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Binary orbit checks&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Binary SMA: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binary_sma</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AU</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Binary Mass Ratio (q): </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">binary_q</span><span class="p">))</span>
        
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;period@orbit&#39;</span><span class="p">,</span> <span class="n">binary_period</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;sma@binary@component&#39;</span><span class="p">,</span> <span class="n">binary_sma</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;q@binary@component&#39;</span><span class="p">,</span> <span class="n">binary_q</span><span class="p">)</span>
        
        <span class="c1">## Inclination</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;incl@orbit&#39;</span><span class="p">,</span> <span class="n">binary_inc</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;long_an@orbit&#39;</span><span class="p">,</span> <span class="mf">180.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;per0@orbit&#39;</span><span class="p">,</span> <span class="mf">180.</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binary orbit characteristics:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;binary@orbit&#39;</span><span class="p">))</span>
            <span class="c1"># print(b.get_parameter(&#39;t0_perpass@binary@component&#39;))</span>
            <span class="c1"># print(b.get_parameter(&#39;t0_supconj@binary@component&#39;))</span>
            <span class="c1"># print(b.get_parameter(&#39;long_an@binary@component&#39;))</span>
            <span class="c1"># print(b.get_parameter(&#39;per0@binary@component&#39;))</span>
            <span class="c1"># print(b.get_parameter(&#39;incl@orbit&#39;))</span>
        
        <span class="c1"># Check for overflow</span>
        
        <span class="c1"># Variables to help store the non-detached binary cases</span>
        <span class="n">star1_semidetached</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">star2_semidetached</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">star1_overflow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">star2_overflow</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Get the max radii for both component stars</span>
        <span class="n">star1_rad_max</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;requiv_max@primary@component&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">solRad</span>
        <span class="n">star2_rad_max</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;requiv_max@secondary@component&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">solRad</span>
        
        <span class="c1">## Check for semidetached cases</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Semidetached checks&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">star1_rad</span> <span class="o">-</span> <span class="n">star1_rad_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">star1_rad_max</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">star2_rad</span> <span class="o">-</span> <span class="n">star2_rad_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">star2_rad_max</span><span class="p">)))</span>
        
        <span class="n">semidet_cut</span> <span class="o">=</span> <span class="mf">0.001</span>   <span class="c1"># (within 0.1% of max radii)</span>
        <span class="n">semidet_cut</span> <span class="o">=</span> <span class="mf">0.015</span>   <span class="c1"># (within 1.5% of max radii)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">star1_rad</span> <span class="o">-</span> <span class="n">star1_rad_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">star1_rad_max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">semidet_cut</span><span class="p">:</span>
            <span class="n">star1_semidetached</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">star2_rad</span> <span class="o">-</span> <span class="n">star2_rad_max</span><span class="p">)</span> <span class="o">/</span> <span class="n">star2_rad_max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">semidet_cut</span><span class="p">:</span>
            <span class="n">star2_semidetached</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Check for overflow</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">star1_rad</span> <span class="o">&gt;</span> <span class="n">star1_rad_max</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">star1_semidetached</span><span class="p">:</span>
            <span class="n">star1_overflow</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">star2_rad</span> <span class="o">&gt;</span> <span class="n">star2_rad_max</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">star2_semidetached</span><span class="p">:</span>
            <span class="n">star2_overflow</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># If both stars are overflowing, check which star overflows more?</span>
        <span class="c1"># Only choose that star to be overflowing</span>
        <span class="k">if</span> <span class="n">star1_overflow</span> <span class="ow">and</span> <span class="n">star2_overflow</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">star1_rad</span> <span class="o">-</span> <span class="n">star1_rad_max</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">star2_rad</span> <span class="o">-</span> <span class="n">star2_rad_max</span><span class="p">):</span>
                <span class="n">star2_overflow</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">star1_overflow</span> <span class="o">=</span> <span class="kc">False</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Overflow Checks&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 Semidetached: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_semidetached</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 Semidetached: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_semidetached</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 Overflow: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_overflow</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 Overflow: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_overflow</span><span class="p">))</span>
        
        <span class="c1"># If star 2 is overflowing, have to re set up model:</span>
        <span class="c1"># Calling this same binary_star_lc function again,</span>
        <span class="c1"># with star 2 as primary and star 1 as secondary.</span>
        <span class="c1"># Change t0 = t0 - per/2 to make sure phase is correct,</span>
        <span class="c1"># wrt stars 1 and 2 being in same respective position</span>
        <span class="k">if</span> <span class="n">star2_overflow</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">star1_overflow</span><span class="p">:</span>
            <span class="n">redo_binary_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">binary_params</span><span class="p">)</span>
            <span class="n">redo_binary_params</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">-</span> <span class="p">(</span><span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_obs</span><span class="p">(</span>
                <span class="n">star2_params</span><span class="p">,</span> <span class="n">star1_params</span><span class="p">,</span>
                <span class="n">redo_binary_params</span><span class="p">,</span>
                <span class="n">irrad_frac_refl</span><span class="o">=</span><span class="n">irrad_frac_refl</span><span class="p">,</span>
                <span class="n">num_triangles</span><span class="o">=</span><span class="n">num_triangles</span><span class="p">,</span>
                <span class="n">make_mesh_plots</span><span class="o">=</span><span class="n">make_mesh_plots</span><span class="p">,</span>
                <span class="n">mesh_temp</span><span class="o">=</span><span class="n">mesh_temp</span><span class="p">,</span> <span class="n">mesh_temp_cmap</span><span class="o">=</span><span class="n">mesh_temp_cmap</span><span class="p">,</span>
                <span class="n">plot_name</span><span class="o">=</span><span class="n">plot_name</span><span class="p">,</span>
            <span class="p">)</span>
        
        <span class="c1">## If none of these overflow cases, set variable to store if binary is detached</span>
        <span class="n">binary_detached</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star1_semidetached</span><span class="p">)</span> <span class="ow">and</span> \
                          <span class="p">(</span><span class="ow">not</span> <span class="n">star2_semidetached</span><span class="p">)</span> <span class="ow">and</span> \
                          <span class="p">(</span><span class="ow">not</span> <span class="n">star1_overflow</span><span class="p">)</span> <span class="ow">and</span> \
                          <span class="p">(</span><span class="ow">not</span> <span class="n">star2_overflow</span><span class="p">)</span>
        
        <span class="c1">### Set non-zero eccentricity only if binary is detached</span>
        <span class="k">if</span> <span class="n">binary_detached</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;ecc@binary@component&#39;</span><span class="p">,</span> <span class="n">binary_ecc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;ecc@binary@component&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        
        <span class="c1">## Change set up for contact or semidetached cases</span>
        <span class="k">if</span> <span class="n">star1_overflow</span> <span class="ow">or</span> <span class="n">star2_overflow</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">phoebe</span><span class="o">.</span><span class="n">default_binary</span><span class="p">(</span><span class="n">contact_binary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1">### Reset all necessary binary properties for contact system</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
            
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;period@orbit&#39;</span><span class="p">,</span> <span class="n">binary_period</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;sma@binary@component&#39;</span><span class="p">,</span> <span class="n">binary_sma</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;q@binary@component&#39;</span><span class="p">,</span> <span class="n">binary_q</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;incl@orbit&#39;</span><span class="p">,</span> <span class="n">binary_inc</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">star1_semidetached</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">star2_overflow</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;semidetached&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">star2_semidetached</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">star1_overflow</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="s1">&#39;semidetached&#39;</span><span class="p">,</span> <span class="s1">&#39;secondary&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set up compute</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_compute</span><span class="p">(</span>
                <span class="s1">&#39;phoebe&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">irrad_method</span><span class="o">=</span><span class="s1">&#39;wilson&#39;</span><span class="p">,</span>
                <span class="n">atm</span><span class="o">=</span><span class="s1">&#39;blackbody&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="c1"># b.add_compute(&#39;phoebe&#39;, compute=&#39;detailed&#39;,</span>
            <span class="c1">#               irrad_method=&#39;horvat&#39;, atm=&#39;blackbody&#39;, distortion_method=&#39;rotstar&#39;)</span>
            
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;atm@primary@detailed&#39;</span><span class="p">,</span> <span class="s1">&#39;blackbody&#39;</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;atm@secondary@detailed&#39;</span><span class="p">,</span> <span class="s1">&#39;blackbody&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_compute</span><span class="p">(</span>
                <span class="s1">&#39;phoebe&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">irrad_method</span><span class="o">=</span><span class="s1">&#39;wilson&#39;</span>
            <span class="p">)</span>
        
        <span class="c1"># Set the parameters of the component stars of the system</span>
        <span class="c1">## Primary</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;teff@primary@component&#39;</span><span class="p">,</span> <span class="n">star1_teff</span><span class="p">)</span>
        <span class="c1"># b.set_value(&#39;logg@primary@component&#39;, star1_logg)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star1_semidetached</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star2_overflow</span><span class="p">):</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;requiv@primary@component&#39;</span><span class="p">,</span> <span class="n">star1_rad</span><span class="p">)</span>
        
        <span class="c1"># Gravity darkening coefficient</span>
        <span class="k">if</span> <span class="n">star1_teff</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>    <span class="c1"># Radiative</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@primary@component&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">star1_teff</span> <span class="o">&lt;</span> <span class="mi">6600</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>   <span class="c1"># Convective</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@primary@component&#39;</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Interpolate between the radiative and convective cases</span>
            <span class="n">star1_gravb</span> <span class="o">=</span> <span class="p">((</span><span class="n">star1_teff</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8000</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">*</span>\
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.32</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.32</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@primary@component&#39;</span><span class="p">,</span> <span class="n">star1_gravb</span><span class="p">)</span>
        
        <span class="c1">## Secondary</span>
        <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;teff@secondary@component&#39;</span><span class="p">,</span> <span class="n">star2_teff</span><span class="p">)</span>
        <span class="c1"># b.set_value(&#39;logg@secondary@component&#39;, star2_logg)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star2_semidetached</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star1_overflow</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star2_overflow</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;requiv@secondary@component&#39;</span><span class="p">,</span> <span class="n">star2_rad</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Overflow Checks&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 Semidetached: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_semidetached</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 Semidetached: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_semidetached</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 Overflow: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star1_overflow</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 2 Overflow: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star2_overflow</span><span class="p">))</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot set secondary radius: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
                
                <span class="k">return</span> <span class="n">err_out</span>
        
        <span class="c1"># Gravity darkening coefficient</span>
        <span class="k">if</span> <span class="n">star2_teff</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>    <span class="c1"># Radiative</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@secondary@component&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">star2_teff</span> <span class="o">&lt;</span> <span class="mi">6600</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>   <span class="c1"># Convective</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@secondary@component&#39;</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Interpolate between the radiative and convective cases</span>
            <span class="n">star2_gravb</span> <span class="o">=</span> <span class="p">((</span><span class="n">star2_teff</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8000</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">*</span>\
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.32</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.32</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@primary@component&#39;</span><span class="p">,</span> <span class="n">star2_gravb</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
           <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Contact envelope parameters:&#39;</span><span class="p">)</span>
           <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;contact_envelope@detailed@compute&#39;</span><span class="p">))</span>
        
        <span class="c1"># Set the number of triangles in the mesh</span>
        <span class="c1"># Detached stars</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;ntriangles@primary@detailed@compute&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="s1">&#39;ntriangles@primary@detailed@compute&#39;</span><span class="p">,</span>
                <span class="n">num_triangles</span><span class="p">,</span>
            <span class="p">)</span>
            
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;ntriangles@secondary@detailed@compute&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> 
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="s1">&#39;ntriangles@secondary@detailed@compute&#39;</span><span class="p">,</span>
                <span class="n">num_triangles</span><span class="p">,</span>
            <span class="p">)</span>
        
        <span class="c1"># Contact envelope</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;ntriangles@contact_envelope@detailed@compute&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
               <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting number of triangles for contact envelope&#39;</span><span class="p">)</span>
           <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
               <span class="s1">&#39;ntriangles@contact_envelope@detailed@compute&#39;</span><span class="p">,</span>
               <span class="n">num_triangles</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
           <span class="p">)</span>
        
        <span class="c1"># Extract times for modeling photometry</span>
        <span class="n">phot_filt_MJDs</span> <span class="o">=</span> <span class="p">{}</span>     <span class="c1"># times, organized by filt</span>
        <span class="n">rv_filt_MJDs</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c1"># times, organized by filt</span>
        
        <span class="n">phot_filt_phase</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rv_filt_phase</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">:</span>
                <span class="n">phot_filt_MJDs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">obs_times</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">phot_filt_filters</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">phot_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="p">((</span><span class="n">phot_filt_MJDs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">%</span>
                     <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_rv</span><span class="p">:</span>
                <span class="n">rv_filt_MJDs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">obs_times</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">rv_filt_filters</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">rv_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="p">((</span><span class="n">rv_filt_MJDs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">%</span>
                     <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        
        <span class="c1"># Add light curve datasets    </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Parameters to change if using a blackbody atmosphere</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_mode_bol&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_func_bol&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_coeffs_bol&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
            
            <span class="c1"># Set irradiation reflection fraction </span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;irrad_frac_refl_bol&#39;</span><span class="p">,</span> <span class="n">irrad_frac_refl</span><span class="p">)</span>
            
            <span class="c1"># Change in setup for compact object</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;irrad_method@detailed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            
            <span class="c1"># Go through each filter and add a lightcurve dataset</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="c1"># PHOEBE sorts outputs by time, so do it ourselves first</span>
                <span class="n">filt_phases_sorted_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                    <span class="n">phot_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
                <span class="p">)</span>
                
                <span class="n">filt_model_times</span> <span class="o">=</span> \
                    <span class="n">phot_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">*</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="n">filt_model_times</span> <span class="o">=</span> <span class="n">filt_model_times</span><span class="p">[</span><span class="n">filt_phases_sorted_inds</span><span class="p">]</span>
                
                <span class="n">b</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                    <span class="n">phoebe</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span>
                    <span class="n">times</span><span class="o">=</span><span class="n">filt_model_times</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                    <span class="n">passband</span><span class="o">=</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_pb_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_mode@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
            
                    <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_func@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            
                    <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_coeffs@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        
        <span class="c1"># Add RV datasets</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Go through each filter and add a RV dataset with all RV times</span>
            <span class="n">rv_model_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_rv</span><span class="p">):</span>
                <span class="c1"># PHOEBE sorts outputs by time, so do it ourselves first</span>
                <span class="n">filt_phases_sorted_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                    <span class="n">rv_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
                <span class="p">)</span>
                
                <span class="n">filt_model_times</span> <span class="o">=</span> \
                    <span class="n">rv_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">*</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                <span class="n">filt_model_times</span> <span class="o">=</span> <span class="n">filt_model_times</span><span class="p">[</span><span class="n">filt_phases_sorted_inds</span><span class="p">]</span>
                
                <span class="c1"># Only add unique times (e.g. if pri and sec RVs are modeled for</span>
                <span class="c1"># a given time)</span>
                <span class="n">filt_model_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">filt_model_times</span><span class="p">)</span>
                
                <span class="n">rv_model_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rv_model_times</span><span class="p">,</span> <span class="n">filt_model_times</span><span class="p">)</span>
            
                
            <span class="n">b</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                <span class="n">phoebe</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">rv</span><span class="p">,</span>
                <span class="n">times</span><span class="o">=</span><span class="n">rv_model_times</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;mod_rv&#39;</span><span class="p">,</span>
                <span class="n">passband</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_rv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">phoebe_pb_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_mode@mod_rv&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
                
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_func@mod_rv&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                
                <span class="n">b</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_coeffs@mod_rv&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        
        <span class="c1"># Add mesh dataset if making mesh plot</span>
        <span class="n">mesh_plot_times</span> <span class="o">=</span> <span class="n">mesh_plot_phases</span> <span class="o">*</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                <span class="s1">&#39;mesh&#39;</span><span class="p">,</span>
                <span class="n">compute_times</span><span class="o">=</span><span class="n">mesh_plot_times</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;mod_mesh&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;coordinates@mesh&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uvw&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mesh_temp</span><span class="p">:</span>
                <span class="n">mesh_columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="s1">&#39;vs&#39;</span><span class="p">,</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;rprojs&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;teffs&#39;</span><span class="p">,</span> <span class="s1">&#39;loggs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;areas&#39;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">:</span>
                    <span class="n">mesh_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">)</span>
                
                <span class="n">b</span><span class="p">[</span><span class="s1">&#39;columns@mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_columns</span>
        
        <span class="c1"># Set the passband luminosities for the stars</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star1_overflow</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">star2_overflow</span><span class="p">):</span>
            <span class="c1"># Detached / semidetached case</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="s1">&#39;pblum_mode@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                    <span class="s1">&#39;decoupled&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                
                <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="s1">&#39;pblum@primary@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                    <span class="n">star1_filt_pblums</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span>
                <span class="p">)</span>
                
                <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                    <span class="s1">&#39;pblum@secondary@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                    <span class="n">star2_filt_pblums</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">star1_overflow</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="s1">&#39;pblum@primary@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                        <span class="n">star1_filt_pblums</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">star2_overflow</span><span class="p">:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                        <span class="s1">&#39;pblum@secondary@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                        <span class="n">star2_filt_pblums</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span>
                    <span class="p">)</span>
        
        <span class="c1"># Run compute</span>
        <span class="c1"># Determine eclipse method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span><span class="p">:</span>
            <span class="n">eclipse_method</span> <span class="o">=</span> <span class="s1">&#39;only_horizon&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eclipse_method</span> <span class="o">=</span> <span class="s1">&#39;native&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying inital compute run&quot;</span><span class="p">)</span>
            <span class="n">b</span><span class="o">.</span><span class="n">run_compute</span><span class="p">(</span>
                <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>
                <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eclipse_method</span><span class="o">=</span><span class="n">eclipse_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">run_compute</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>
                              <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eclipse_method</span><span class="o">=</span><span class="n">eclipse_method</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error during primary binary compute: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                         <span class="p">)</span>
                <span class="k">return</span> <span class="n">err_out</span>
        
        <span class="c1"># Save out mesh plot</span>
        <span class="n">mesh_plot_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="c1">## Plot Nerdery</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="s1">&#39;Computer Modern Roman&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text.latex&#39;</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\usepackage</span><span class="si">{gensymb}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="c1"># plt.rc(&#39;xtick&#39;, top = True)</span>
            <span class="c1"># plt.rc(&#39;ytick&#39;, right = True)</span>
            
            <span class="n">plot_name_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">plot_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_name_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s1">&#39;</span>
            
            <span class="k">if</span> <span class="n">animate</span><span class="p">:</span>
                <span class="c1"># Save out animation</span>
                <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mod_mesh@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">save</span><span class="o">=</span><span class="s1">&#39;./binary_mesh</span><span class="si">{0}</span><span class="s1">.gif&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_name_suffix</span><span class="p">),</span>
                    <span class="n">save_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;writer&#39;</span><span class="p">:</span> <span class="s1">&#39;imagemagick&#39;</span><span class="p">},</span>
                <span class="p">)</span>
                        
            <span class="n">calls_list</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Go through each mesh model time and save</span>
            <span class="k">for</span> <span class="n">mesh_index</span><span class="p">,</span> <span class="n">mesh_plot_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mesh_plot_times</span><span class="p">):</span>
                <span class="n">plot_phase_suffix</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mesh_plot_phases</span><span class="p">[</span><span class="n">mesh_index</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                
                <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="c1"># Add kwargs for handling figure of mesh plot</span>
                <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_plot_fig</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="s1">&#39;./binary_mesh</span><span class="si">{0}{1}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">plot_name_suffix</span><span class="p">,</span> <span class="n">plot_phase_suffix</span><span class="p">,</span>
                        <span class="p">)</span>
                
                <span class="c1"># Add kwargs if coloring mesh plot by Teff</span>
                <span class="k">if</span> <span class="n">mesh_temp</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;teffs&#39;</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fcmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_temp_cmap</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;ec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;face&#39;</span>
                
                <span class="c1"># Add kwargs if making grid of mesh plots with a subplot grid</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mesh_plot_subplot_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">mesh_plot_subplot_grid_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;axpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">mesh_plot_subplot_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">mesh_plot_subplot_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">mesh_plot_subplot_grid_indexes</span><span class="p">[</span><span class="n">mesh_index</span><span class="p">],</span>
                    <span class="p">)</span>
                
                <span class="c1"># Draw plot</span>
                <span class="p">(</span><span class="n">mesh_af_fig</span><span class="p">,</span> <span class="n">mesh_plt_fig</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mod_mesh@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">mesh_plot_time</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">mesh_plot_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                
                <span class="n">mesh_plot_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh_plt_fig</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="c1"># Have to turn off sidebar if making subplots with Teff faces</span>
                <span class="k">if</span> <span class="n">mesh_temp</span> <span class="ow">and</span> <span class="n">mesh_plot_subplot_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;draw_sidebars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="p">(</span><span class="n">mesh_af_fig</span><span class="p">,</span> <span class="n">mesh_plt_fig</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;mod_mesh@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
                    <span class="n">save</span><span class="o">=</span><span class="s1">&#39;./binary_mesh</span><span class="si">{0}{1}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">plot_name_suffix</span><span class="p">,</span> <span class="n">plot_phase_suffix</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">mesh_plot_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
            
            <span class="c1"># mesh_plot_fig = mesh_plt_fig</span>
            
            <span class="c1">## Mesh plot</span>
            <span class="c1"># if mesh_temp:</span>
            <span class="c1">#     mesh_plot_out = b[&#39;mod_mesh@model&#39;].plot(</span>
            <span class="c1">#                         save=&#39;./binary_mesh{0}.pdf&#39;.format(suffix_str),</span>
            <span class="c1">#                         fc=&#39;teffs&#39;,</span>
            <span class="c1">#                         fcmap=self.mesh_temp_cmap,</span>
            <span class="c1">#                         ec=&#39;none&#39;,</span>
            <span class="c1">#                     )</span>
            <span class="c1">#                                              </span>
            <span class="c1">#     # print(mesh_plot_out.axs)</span>
            <span class="c1">#     </span>
            <span class="c1">#     # Extract and output mesh quantities</span>
            <span class="c1">#     mesh_quant_names = [&#39;us&#39;, &#39;vs&#39;, &#39;ws&#39;, &#39;rprojs&#39;,</span>
            <span class="c1">#                         &#39;teffs&#39;, &#39;loggs&#39;, &#39;rs&#39;, &#39;areas&#39;,</span>
            <span class="c1">#                         &#39;abs_intensities&#39;]</span>
            <span class="c1">#     mesh_quant_do_filt = [False, False, False, False,</span>
            <span class="c1">#                           False, False, False, False,</span>
            <span class="c1">#                           True]</span>
            <span class="c1">#     mesh_quant_units = [u.solRad, u.solRad, u.solRad, u.solRad,</span>
            <span class="c1">#                         u.K, 1.0, u.solRad, u.solRad**2,</span>
            <span class="c1">#                         u.W / (u.m**3)]</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quant_filts = []</span>
            <span class="c1">#     for filt in self.bin_observables.unique_filts_phot:</span>
            <span class="c1">#         mesh_quant_filts.append(filt.phoebe_ds_name)</span>
            <span class="c1">#                 </span>
            <span class="c1">#     mesh_quants_pri = {}</span>
            <span class="c1">#     mesh_quants_sec = {}</span>
            <span class="c1">#     </span>
            <span class="c1">#     for (quant, do_filt,</span>
            <span class="c1">#          quant_unit) in zip(mesh_quant_names, mesh_quant_do_filt,</span>
            <span class="c1">#                             mesh_quant_units):</span>
            <span class="c1">#         if do_filt:</span>
            <span class="c1">#             for filt in mesh_quant_filts:</span>
            <span class="c1">#                 quant_pri = b[f&#39;{quant}@primary@{filt}&#39;].value *\</span>
            <span class="c1">#                             quant_unit</span>
            <span class="c1">#                 quant_sec = b[f&#39;{quant}@secondary@{filt}&#39;].value *\</span>
            <span class="c1">#                             quant_unit</span>
            <span class="c1">#             </span>
            <span class="c1">#                 mesh_quants_pri[f&#39;{quant}_{filt}&#39;] = quant_pri</span>
            <span class="c1">#                 mesh_quants_sec[f&#39;{quant}_{filt}&#39;] = quant_sec</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             quant_pri = b[f&#39;{quant}@primary&#39;].value * quant_unit</span>
            <span class="c1">#             quant_sec = b[f&#39;{quant}@secondary&#39;].value * quant_unit</span>
            <span class="c1">#             </span>
            <span class="c1">#             mesh_quants_pri[quant] = quant_pri</span>
            <span class="c1">#             mesh_quants_sec[quant] = quant_sec</span>
            <span class="c1">#     </span>
            <span class="c1">#     # Get uvw coordinates of each vertix of triangle in mesh</span>
            <span class="c1">#     uvw_elements_pri = b.get_parameter(qualifier=&#39;uvw_elements&#39;, </span>
            <span class="c1">#                           component=&#39;primary&#39;, </span>
            <span class="c1">#                           dataset=&#39;mod_mesh&#39;,</span>
            <span class="c1">#                           kind=&#39;mesh&#39;, </span>
            <span class="c1">#                           context=&#39;model&#39;).value * u.solRad</span>
            <span class="c1">#     uvw_elements_sec = b.get_parameter(qualifier=&#39;uvw_elements&#39;, </span>
            <span class="c1">#                           component=&#39;secondary&#39;, </span>
            <span class="c1">#                           dataset=&#39;mod_mesh&#39;,</span>
            <span class="c1">#                           kind=&#39;mesh&#39;, </span>
            <span class="c1">#                           context=&#39;model&#39;).value * u.solRad</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_pri[&#39;v1_us&#39;] = uvw_elements_pri[:,0,0]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v1_vs&#39;] = uvw_elements_pri[:,0,1]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v1_ws&#39;] = uvw_elements_pri[:,0,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_pri[&#39;v2_us&#39;] = uvw_elements_pri[:,1,0]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v2_vs&#39;] = uvw_elements_pri[:,1,1]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v2_ws&#39;] = uvw_elements_pri[:,1,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_pri[&#39;v3_us&#39;] = uvw_elements_pri[:,2,0]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v3_vs&#39;] = uvw_elements_pri[:,2,1]</span>
            <span class="c1">#     mesh_quants_pri[&#39;v3_ws&#39;] = uvw_elements_pri[:,2,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_sec[&#39;v1_us&#39;] = uvw_elements_sec[:,0,0]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v1_vs&#39;] = uvw_elements_sec[:,0,1]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v1_ws&#39;] = uvw_elements_sec[:,0,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_sec[&#39;v2_us&#39;] = uvw_elements_sec[:,1,0]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v2_vs&#39;] = uvw_elements_sec[:,1,1]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v2_ws&#39;] = uvw_elements_sec[:,1,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_quants_sec[&#39;v3_us&#39;] = uvw_elements_sec[:,2,0]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v3_vs&#39;] = uvw_elements_sec[:,2,1]</span>
            <span class="c1">#     mesh_quants_sec[&#39;v3_ws&#39;] = uvw_elements_sec[:,2,2]</span>
            <span class="c1">#     </span>
            <span class="c1">#     </span>
            <span class="c1">#     # Construct mesh tables for each star and output</span>
            <span class="c1">#     mesh_pri_table = Table(mesh_quants_pri)</span>
            <span class="c1">#     mesh_pri_table.sort([&#39;us&#39;], reverse=True)</span>
            <span class="c1">#     with open(&#39;mesh_pri.txt&#39;, &#39;w&#39;) as out_file:</span>
            <span class="c1">#         for line in mesh_pri_table.pformat_all():</span>
            <span class="c1">#             out_file.write(line + &#39;\n&#39;)</span>
            <span class="c1">#     mesh_pri_table.write(&#39;mesh_pri.h5&#39;, format=&#39;hdf5&#39;,</span>
            <span class="c1">#                          path=&#39;data&#39;, serialize_meta=True,</span>
            <span class="c1">#                          overwrite=True)</span>
            <span class="c1">#     mesh_pri_table.write(&#39;mesh_pri.fits&#39;, format=&#39;fits&#39;,</span>
            <span class="c1">#                          overwrite=True)</span>
            <span class="c1">#     </span>
            <span class="c1">#     mesh_sec_table = Table(mesh_quants_sec)</span>
            <span class="c1">#     mesh_sec_table.sort([&#39;us&#39;], reverse=True)</span>
            <span class="c1">#     with open(&#39;mesh_sec.txt&#39;, &#39;w&#39;) as out_file:</span>
            <span class="c1">#         for line in mesh_sec_table.pformat_all():</span>
            <span class="c1">#             out_file.write(line + &#39;\n&#39;)</span>
            <span class="c1">#     mesh_sec_table.write(&#39;mesh_sec.h5&#39;, format=&#39;hdf5&#39;,</span>
            <span class="c1">#                          path=&#39;data&#39;, serialize_meta=True,</span>
            <span class="c1">#                          overwrite=True)</span>
            <span class="c1">#     mesh_sec_table.write(&#39;mesh_sec.fits&#39;, format=&#39;fits&#39;,</span>
            <span class="c1">#                          overwrite=True)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     mesh_plot_out = b[&#39;mod_mesh@model&#39;].plot(save=&#39;./binary_mesh{0}.pdf&#39;.format(suffix_str))</span>
        
        
        <span class="c1"># Get fluxes</span>
        <span class="n">phot_model_fluxes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phot_model_mags</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>        
            <span class="c1"># Go through each filter</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="n">cur_filt_model_fluxes</span> <span class="o">=</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fluxes@lc@</span><span class="si">{</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="si">}</span><span class="s1">@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>\
                    <span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">cur_filt_model_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cur_filt_model_fluxes</span> <span class="o">/</span> <span class="n">filt</span><span class="o">.</span><span class="n">flux_ref_filt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.03</span>
                
                <span class="n">phot_model_fluxes</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_filt_model_fluxes</span>
                <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_filt_model_mags</span>
        
        <span class="c1"># Get RVs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_RVs_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;rvs@primary@run@rv@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">model_RVs_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;rvs@secondary@run@rv@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_RVs_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">model_RVs_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux Checks&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fluxes, </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filt</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
                    <span class="n">phot_model_fluxes</span><span class="p">[</span><span class="n">filt</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mags, </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filt</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
                    <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">]))</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RV Checks&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RVs, Primary: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_RVs_pri</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RVs, Secondary: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_RVs_sec</span><span class="p">))</span>
        
        <span class="c1"># Set up output observables object</span>
        <span class="n">bin_observables_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="p">)</span>
    
        <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">set_obs</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_times</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="c1"># Set photometric modeled observations back in original input order</span>
        <span class="k">if</span> <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="c1"># Set up filter for observations in correct passband</span>
                <span class="n">obs_filt_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_types</span> <span class="o">==</span> <span class="s1">&#39;phot&#39;</span><span class="p">,</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_filts</span> <span class="o">==</span> <span class="n">filt</span><span class="p">,</span>
                <span class="p">))</span>
                
                <span class="n">modeled_fluxes_filt</span> <span class="o">=</span> <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_filt_filter</span><span class="p">]</span>
                
                <span class="c1"># Determine how the original observations were sorted</span>
                <span class="n">filt_phases_sorted_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
                    <span class="n">phot_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
                <span class="p">)</span>
                
                <span class="c1"># Go through each model observation and put that thing back</span>
                <span class="c1"># where it came from (, or so help me!)</span>
                <span class="k">for</span> <span class="n">obs_index</span><span class="p">,</span> <span class="n">sorted_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filt_phases_sorted_inds</span><span class="p">):</span>
                    <span class="n">modeled_fluxes_filt</span><span class="p">[</span><span class="n">obs_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="n">sorted_index</span><span class="p">]</span>
                
                <span class="c1"># Save back out into output observables object</span>
                <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">obs_filt_filter</span><span class="p">]</span> <span class="o">=</span> <span class="n">modeled_fluxes_filt</span>
                
        <span class="c1"># Set RV modeled observations back in original input order</span>
        <span class="k">if</span> <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_rv</span><span class="p">):</span>
                <span class="c1"># Set up filter for observations for correct star</span>
                <span class="n">modeled_RVs_pri</span> <span class="o">=</span> <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_rv_pri_filter</span>
                <span class="p">]</span>
                <span class="n">modeled_RVs_sec</span> <span class="o">=</span> <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_rv_sec_filter</span>
                <span class="p">]</span>
                
                <span class="n">rv_pri_phases</span> <span class="o">=</span> <span class="p">((</span><span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_times_rv_pri</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">%</span>
                    <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                
                <span class="n">rv_sec_phases</span> <span class="o">=</span> <span class="p">((</span><span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_times_rv_pri</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">%</span>
                    <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                
                <span class="c1"># Get phases of the times that were modeled in model order</span>
                <span class="n">rv_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="p">((</span><span class="n">rv_filt_MJDs</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">%</span>
                    <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">/</span> <span class="n">binary_period</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
                
                <span class="c1"># Determine the original observation times</span>
                <span class="n">RV_phases_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rv_filt_phase</span><span class="p">[</span><span class="n">filt</span><span class="p">])</span>
                <span class="p">)</span>
                
                <span class="c1"># Go through each model observation and put that thing back</span>
                <span class="c1"># where it came from (, or so help me!)</span>
                <span class="k">for</span> <span class="n">cur_model_index</span><span class="p">,</span> <span class="n">cur_phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">RV_phases_sorted</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">cur_phase</span> <span class="ow">in</span> <span class="n">rv_pri_phases</span><span class="p">:</span>
                        <span class="n">modeled_RVs_pri</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">rv_pri_phases</span> <span class="o">==</span> <span class="n">cur_phase</span><span class="p">)]</span> <span class="o">=</span>\
                            <span class="n">model_RVs_pri</span><span class="p">[</span><span class="n">cur_model_index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cur_phase</span> <span class="ow">in</span> <span class="n">rv_sec_phases</span><span class="p">:</span>
                        <span class="n">modeled_RVs_sec</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">rv_sec_phases</span> <span class="o">==</span> <span class="n">cur_phase</span><span class="p">)]</span> <span class="o">=</span>\
                            <span class="n">model_RVs_sec</span><span class="p">[</span><span class="n">cur_model_index</span><span class="p">]</span>
                
                <span class="c1"># Save back out into output observables object</span>
                <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_rv_pri_filter</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">modeled_RVs_pri</span>
                <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">bin_observables_out</span><span class="o">.</span><span class="n">obs_rv_sec_filter</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">modeled_RVs_sec</span>
        
        <span class="c1"># Return modeled observables, and mesh plot if being made</span>
        <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bin_observables_out</span><span class="p">,</span> <span class="n">mesh_plot_out</span><span class="p">,</span> <span class="n">mesh_plot_fig</span>
        <span class="k">elif</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bin_observables_out</span><span class="p">,</span> <span class="n">mesh_plot_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bin_observables_out</span></div></div>

<div class="viewcode-block" id="single_star_model_obs"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.single_star_model_obs">[docs]</a><span class="k">class</span> <span class="nc">single_star_model_obs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to compute the observables for a modeled binary system,</span>
<span class="sd">    given stellar parameters and binary parameters.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sing_star_observables : observables</span>
<span class="sd">        observables object, with obs_times, obs_filts, and obs_types specified.</span>
<span class="sd">    use_blackbody_atm : bool, default=False</span>
<span class="sd">        Use blackbody atmosphere instead of default Castelli &amp; Kurucz</span>
<span class="sd">        atmosphere. Default: False (i.e.: using a C&amp;K atm by default)</span>
<span class="sd">    use_compact_object : bool, default=False</span>
<span class="sd">        If true, sets eclipse_method to &#39;only_horizon&#39; in PHOEBE, which is</span>
<span class="sd">        necessary for compact companions without eclipses. Default: False</span>
<span class="sd">    </span>
<span class="sd">    print_diagnostics : bool, default=False</span>
<span class="sd">        Print diagnostic messages, helpful for debugging.</span>
<span class="sd">    par_compute : bool, default=False</span>
<span class="sd">        Uses parallelization when computing with PHOEBE.</span>
<span class="sd">    num_par_processes : int, default=8</span>
<span class="sd">        Number of processes to use when parallel computing with PHOEBE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">sing_star_observables</span><span class="p">,</span>
            <span class="n">use_blackbody_atm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_compact_object</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">print_diagnostics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">par_compute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_par_processes</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span> <span class="o">=</span> <span class="n">sing_star_observables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span> <span class="o">=</span> <span class="n">use_blackbody_atm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span> <span class="o">=</span> <span class="n">use_compact_object</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span> <span class="o">=</span> <span class="n">print_diagnostics</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">par_compute</span> <span class="o">=</span> <span class="n">par_compute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_par_processes</span> <span class="o">=</span> <span class="n">num_par_processes</span>
        
        <span class="k">return</span>
    
<div class="viewcode-block" id="single_star_model_obs.compute_obs"><a class="viewcode-back" href="../autoapi/model_obs_calc/index.html#model_obs_calc.single_star_model_obs.compute_obs">[docs]</a>    <span class="k">def</span> <span class="nf">compute_obs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">star1_params</span><span class="p">,</span>
            <span class="n">num_triangles</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
            <span class="n">make_mesh_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">mesh_plot_fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_subplot_grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_subplot_grid_indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_temp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mesh_temp_cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">plot_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">mesh_plot_kwargs</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute observables with the specified star and binary</span>
<span class="sd">        system parameters.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        star1_params : star_params</span>
<span class="sd">            star_params object, with parameters for the star.</span>
<span class="sd">        num_triangles : int, default=1500</span>
<span class="sd">            Number of triangles to use for PHOEBE&#39;s mesh model of each stellar</span>
<span class="sd">            atmosphere. For contact system, num_triangles*2 are used for contact</span>
<span class="sd">            envelope.</span>
<span class="sd">        make_mesh_plots : bool, default=False</span>
<span class="sd">            Make a mesh plot of the binary system. Default: False</span>
<span class="sd">        plot_name : str, default=None</span>
<span class="sd">            Name for the output plots, if making a mesh plot</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        observables</span>
<span class="sd">            observables object returned. Deep copy of input observables object,</span>
<span class="sd">            with obs also defined, with modeled values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">par_compute</span><span class="p">:</span>
            <span class="n">phoebe</span><span class="o">.</span><span class="n">mpi_on</span><span class="p">(</span><span class="n">nprocs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_par_processes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phoebe</span><span class="o">.</span><span class="n">mpi_off</span><span class="p">()</span>
        
        <span class="c1"># Read in the stellar parameters of the binary components</span>
        <span class="n">star_mass</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">mass</span>
        <span class="n">star_rad</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">rad</span>
        <span class="n">star_teff</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">teff</span>
        <span class="n">star_logg</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">logg</span>
        <span class="n">star_filt_pblums</span> <span class="o">=</span> <span class="n">star1_params</span><span class="o">.</span><span class="n">pblums</span>
        
        <span class="n">err_out</span> <span class="o">=</span> <span class="n">observables</span><span class="o">.</span><span class="n">observables</span><span class="p">(</span>
            <span class="n">obs_times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
            <span class="n">obs</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]),</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="n">err_out</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">])),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">]))</span>
        
        <span class="c1"># Check for high temp ck2004 atmosphere limits</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
            <span class="c1"># log g = 3.5, high temp bounds (above 31e3 K)</span>
            <span class="k">if</span> <span class="n">star_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">31_000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.0</span> <span class="o">&gt;</span> <span class="n">star_logg</span> <span class="o">&gt;</span> <span class="mf">3.5</span><span class="p">):</span>
                <span class="n">star_teff_round</span> <span class="o">=</span> <span class="mf">30995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star is out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star1_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_logg</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star1_teff&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_teff</span><span class="p">,</span> <span class="n">star_teff_round</span><span class="p">))</span>
                
                <span class="n">star_teff</span> <span class="o">=</span> <span class="n">star_teff_round</span>
            
            <span class="c1"># log g = 4.0, high temp bounds (above 40e3 K)</span>
            <span class="k">if</span> <span class="n">star_teff</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">40000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mf">4.5</span> <span class="o">&gt;</span> <span class="n">star_logg</span> <span class="o">&gt;</span> <span class="mf">4.0</span><span class="p">):</span>
                <span class="n">star_teff_round</span> <span class="o">=</span> <span class="mf">39995.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star 1 out of C&amp;K 2004 grid&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;star_logg = </span><span class="si">{0:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_logg</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rounding down star_teff&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:.4f}</span><span class="s1"> -&gt; </span><span class="si">{1:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">star_teff</span><span class="p">,</span> <span class="n">star_teff_round</span><span class="p">))</span>
                
                <span class="n">star_teff</span> <span class="o">=</span> <span class="n">star_teff_round</span>        
        
        <span class="c1"># Set up a single star model</span>
        <span class="n">sing_star</span> <span class="o">=</span> <span class="n">phoebe</span><span class="o">.</span><span class="n">default_star</span><span class="p">()</span>
        
        <span class="c1">## Set a default distance</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>
        
        <span class="c1"># Set up compute</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">add_compute</span><span class="p">(</span>
                <span class="s1">&#39;phoebe&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span>
                <span class="n">distortion_method</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                <span class="n">irrad_method</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                <span class="n">atm</span><span class="o">=</span><span class="s1">&#39;blackbody&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">add_compute</span><span class="p">(</span>
                <span class="s1">&#39;phoebe&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span>
                <span class="n">distortion_method</span><span class="o">=</span><span class="s1">&#39;sphere&#39;</span><span class="p">,</span>
                <span class="n">irrad_method</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        
        <span class="c1"># Set the stellar parameters</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;teff@component&#39;</span><span class="p">,</span> <span class="n">star_teff</span><span class="p">)</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;mass@component&#39;</span><span class="p">,</span> <span class="n">star_mass</span><span class="p">)</span>
        <span class="c1"># sing_star.set_value(&#39;logg@component&#39;, star_logg)</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;requiv@component&#39;</span><span class="p">,</span> <span class="n">star_rad</span><span class="p">)</span>
        
        <span class="c1"># Setting long rotation period so that large stellar radii can be stable</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;period@component&#39;</span><span class="p">,</span> <span class="mf">9e3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">yr</span><span class="p">)</span>
        
        <span class="c1"># Gravity darkening coefficient</span>
        <span class="k">if</span> <span class="n">star_teff</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>    <span class="c1"># Radiative</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@component&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">star_teff</span> <span class="o">&lt;</span> <span class="mi">6600</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>   <span class="c1"># Convective</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@component&#39;</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Interpolate between the radiative and convective cases</span>
            <span class="n">star_gravb</span> <span class="o">=</span> <span class="p">((</span><span class="n">star_teff</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8000</span> <span class="o">-</span> <span class="mi">6600</span><span class="p">)</span> <span class="o">*</span>\
                <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.32</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.32</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;gravb_bol@component&#39;</span><span class="p">,</span> <span class="n">star_gravb</span><span class="p">)</span>
        
        <span class="c1"># Set the number of triangles in the mesh</span>
        <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;ntriangles@detailed@compute&#39;</span><span class="p">,</span> <span class="n">num_triangles</span><span class="p">)</span>
        
        <span class="c1"># Add light curve datasets    </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Parameters to change if using a blackbody atmosphere</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_mode_bol&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_func_bol&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_coeffs_bol&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
            
            <span class="c1"># Change in setup for compact object</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span><span class="p">:</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;irrad_method@detailed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            
            <span class="c1"># Go through each filter and add a lightcurve dataset</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                    <span class="n">phoebe</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">lc</span><span class="p">,</span>
                    <span class="n">times</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                    <span class="n">passband</span><span class="o">=</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_pb_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_blackbody_atm</span><span class="p">:</span>
                    <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_mode@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
                    <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_func@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
            
                    <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value_all</span><span class="p">(</span><span class="s1">&#39;ld_coeffs@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        
        <span class="c1"># Not adding RV datasets since just a single star.</span>
        
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">add_dataset</span><span class="p">(</span>
                <span class="s1">&#39;mesh&#39;</span><span class="p">,</span>
                <span class="n">compute_times</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;mod_mesh&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s1">&#39;coordinates@mesh&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;uvw&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">mesh_temp</span><span class="p">:</span>
                <span class="n">mesh_columns</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;us&#39;</span><span class="p">,</span> <span class="s1">&#39;vs&#39;</span><span class="p">,</span> <span class="s1">&#39;ws&#39;</span><span class="p">,</span> <span class="s1">&#39;rprojs&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;teffs&#39;</span><span class="p">,</span> <span class="s1">&#39;loggs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;areas&#39;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">:</span>
                    <span class="n">mesh_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">)</span>
                
                <span class="n">sing_star</span><span class="p">[</span><span class="s1">&#39;columns@mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_columns</span>
        
        <span class="c1"># Set the passband luminosities for the stars</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="s1">&#39;pblum_mode@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                <span class="s1">&#39;decoupled&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            
            <span class="n">sing_star</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span>
                <span class="s1">&#39;pblum@&#39;</span> <span class="o">+</span> <span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="p">,</span>
                <span class="n">star_filt_pblums</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Star Parameters in PHOEBE:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sing_star</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s1">&#39;starA@component&#39;</span><span class="p">))</span>
        
        <span class="c1"># Run compute</span>
        <span class="c1"># Determine eclipse method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_compact_object</span><span class="p">:</span>
            <span class="n">eclipse_method</span> <span class="o">=</span> <span class="s1">&#39;only_horizon&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eclipse_method</span> <span class="o">=</span> <span class="s1">&#39;native&#39;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying inital compute run&quot;</span><span class="p">)</span>
            <span class="n">sing_star</span><span class="o">.</span><span class="n">run_compute</span><span class="p">(</span>
                <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>
                <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="c1"># eclipse_method=eclipse_method,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sing_star</span><span class="o">.</span><span class="n">run_compute</span><span class="p">(</span>
                    <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;detailed&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span>
                    <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eclipse_method</span><span class="o">=</span><span class="n">eclipse_method</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Error during primary binary compute: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">err_out</span>
        
        <span class="c1"># Save out mesh plot</span>
        <span class="n">mesh_plot_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="c1">## Plot Nerdery</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;serif&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="s1">&#39;Computer Modern Roman&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text.latex&#39;</span><span class="p">,</span> <span class="n">preamble</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\usepackage</span><span class="si">{gensymb}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="c1"># plt.rc(&#39;xtick&#39;, top = True)</span>
            <span class="c1"># plt.rc(&#39;ytick&#39;, right = True)</span>
            
            <span class="n">plot_name_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">plot_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_name_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s1">&#39;</span>
            
            <span class="n">calls_list</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Go through each mesh model time and save</span>
            <span class="k">for</span> <span class="n">mesh_index</span><span class="p">,</span> <span class="n">mesh_plot_time</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">plot_phase_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
                <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="c1"># Add kwargs for handling figure of mesh plot</span>
                <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_plot_fig</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;save&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="s1">&#39;./binary_mesh</span><span class="si">{0}{1}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">plot_name_suffix</span><span class="p">,</span> <span class="n">plot_phase_suffix</span><span class="p">,</span>
                        <span class="p">)</span>
                
                <span class="c1"># Add kwargs if coloring mesh plot by Teff</span>
                <span class="k">if</span> <span class="n">mesh_temp</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;teffs&#39;</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;fcmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_temp_cmap</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;ec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;face&#39;</span>
                
                <span class="c1"># Add kwargs if making grid of mesh plots with a subplot grid</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mesh_plot_subplot_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="n">mesh_plot_subplot_grid_indexes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;axpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">mesh_plot_subplot_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">mesh_plot_subplot_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">mesh_plot_subplot_grid_indexes</span><span class="p">[</span><span class="n">mesh_index</span><span class="p">],</span>
                    <span class="p">)</span>
                
                <span class="c1"># Draw plot</span>
                <span class="p">(</span><span class="n">mesh_af_fig</span><span class="p">,</span> <span class="n">mesh_plt_fig</span><span class="p">)</span> <span class="o">=</span> <span class="n">sing_star</span><span class="p">[</span><span class="s1">&#39;mod_mesh@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">mesh_plot_time</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">mesh_plot_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                
                <span class="n">mesh_plot_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh_plt_fig</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">additional_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="c1"># Have to turn off sidebar if making subplots with Teff faces</span>
                <span class="k">if</span> <span class="n">mesh_temp</span> <span class="ow">and</span> <span class="n">mesh_plot_subplot_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">additional_kwargs</span><span class="p">[</span><span class="s1">&#39;draw_sidebars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="p">(</span><span class="n">mesh_af_fig</span><span class="p">,</span> <span class="n">mesh_plt_fig</span><span class="p">)</span> <span class="o">=</span> <span class="n">sing_star</span><span class="p">[</span><span class="s1">&#39;mod_mesh@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">show</span><span class="p">(</span>
                    <span class="n">save</span><span class="o">=</span><span class="s1">&#39;./binary_mesh</span><span class="si">{0}{1}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">plot_name_suffix</span><span class="p">,</span> <span class="n">plot_phase_suffix</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_kwargs</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">mesh_plot_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
        
        <span class="c1"># Get fluxes</span>
        <span class="n">phot_model_fluxes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phot_model_mags</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>        
            <span class="c1"># Go through each filter</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="n">cur_filt_model_fluxes</span> <span class="o">=</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sing_star</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;fluxes@lc@</span><span class="si">{</span><span class="n">filt</span><span class="o">.</span><span class="n">phoebe_ds_name</span><span class="si">}</span><span class="s1">@model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>\
                    <span class="n">u</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">cur_filt_model_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cur_filt_model_fluxes</span> <span class="o">/</span> <span class="n">filt</span><span class="o">.</span><span class="n">flux_ref_filt</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.03</span>
                
                <span class="n">phot_model_fluxes</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_filt_model_fluxes</span>
                <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_filt_model_mags</span>
        
        <span class="c1"># Get RVs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model_RVs_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
            <span class="n">model_RVs_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_RVs_pri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">model_RVs_sec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_diagnostics</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Flux Checks&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fluxes, </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filt</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
                    <span class="n">phot_model_fluxes</span><span class="p">[</span><span class="n">filt</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mags, </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">filt</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
                    <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">]))</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RV Checks&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RVs, Primary: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_RVs_pri</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RVs, Secondary: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_RVs_sec</span><span class="p">))</span>
        
        <span class="c1"># Set up output observables object</span>
        <span class="n">sing_star_observables_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="p">)</span>
        
        <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">set_obs</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs_times</span><span class="p">))</span>
        <span class="p">)</span>
        
        <span class="c1"># Set photometric modeled observations back in original input order</span>
        <span class="k">if</span> <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">num_obs_phot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_phot</span><span class="p">):</span>
                <span class="c1"># Set up filter for observations in correct passband</span>
                <span class="n">obs_filt_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs_types</span> <span class="o">==</span> <span class="s1">&#39;phot&#39;</span><span class="p">,</span>
                    <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs_filts</span> <span class="o">==</span> <span class="n">filt</span><span class="p">,</span>
                <span class="p">))</span>
                
                <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">obs_filt_filter</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">phot_model_mags</span><span class="p">[</span><span class="n">filt</span><span class="p">]</span>
        
        <span class="c1"># Set RV modeled observations back in original input order</span>
        <span class="k">if</span> <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">num_obs_rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">filt_index</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sing_star_observables</span><span class="o">.</span><span class="n">unique_filts_rv</span><span class="p">):</span>
                <span class="c1"># Set up filter for observations for correct star</span>
                <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs_rv_pri_filter</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">model_RVs_pri</span>
                <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                    <span class="n">sing_star_observables_out</span><span class="o">.</span><span class="n">obs_rv_sec_filter</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">model_RVs_sec</span>
                
        <span class="c1"># Return modeled observables, and mesh plot if being made</span>
        <span class="k">if</span> <span class="n">mesh_plot_fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sing_star_observables_out</span><span class="p">,</span> <span class="n">mesh_plot_out</span><span class="p">,</span> <span class="n">mesh_plot_fig</span>
        <span class="k">elif</span> <span class="n">make_mesh_plots</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sing_star_observables_out</span><span class="p">,</span> <span class="n">mesh_plot_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sing_star_observables_out</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index.html">
    <img class="logo" src="../_static/Phitter.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2024, Abhimat K. Gautam.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>